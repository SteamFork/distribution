#!/bin/bash

# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2024 SteamFork (https://github.com/SteamFork)

# Source predefined functions and variables
. /etc/profile

source steamfork-devicequirk-set

### Enable logging
case $(steamfork-get-setting system.loglevel) in
    verbose)
	VERBOSE=true
	;;
    debug)
	VERBOSE=true
	DEBUG=true
	;;
    *)
	VERBOSE=false
	DEBUG=false
	;;
esac

if [ "${AUDIO_WATCHDOG}" = "false" ]
then
    $VERBOSE && echo "Watchdog is disabled on this device."
    exit 0
fi

### Wait for audio to initialize and become available.
while true
do
    CURRENT_SINK=$(pactl get-default-sink)
    $VERBOSE && echo "Current Sink: ${CURRENT_SINK}"
    if [ ! "${CURRENT_SINK}" = "auto_null" ]
    then
	break
    fi
    sleep .1
done

function silent_init() {
    $VERBOSE && echo "Initializing audio silently."
    aplay /usr/share/sounds/silent.wav >/dev/null 2>&1
}

function clear_default() {
	$VERBOSE && echo "Cleared the default sink."
	wpctl clear-default
}

function connect_sink() {
	local LOG_HEADER="${1}"
	local SINK_TYPE="${2}"
	local SINK_RETRY="${3}"

	local AUDIO_PROFILE=$(steamfork-get-setting audio.profile)
	for CONNECT_TIMER in $(seq 1 1 ${SINK_RETRY})
	do
		local CARD_ID=$(pactl list short cards | awk '/'${SINK_TYPE}'/ {print $1; exit}')
		local CARD_SINK=$(pactl list short sinks | awk '/'${SINK_TYPE}'/ {print $2; exit}')
		if [ -n "${CARD_SINK}" ]
		then
			local CURRENT_SINK=$(pactl get-default-sink)
			if [ ! "${CARD_SINK}" == "${CURRENT_SINK}" ]
			then
				clear_default
				$VERBOSE && echo "${LOG_HEADER}: Set default sink to ${CARD_SINK} (${SINK_TYPE})."
				pactl set-default-sink ${CARD_SINK}
				pactl set-default-source ${CARD_SINK}.monitor
				if [ -n "${AUDIO_PROFILE}" ]
				then
					$VERBOSE && echo "${LOG_HEADER}: Set ${CARD_ID} to ${AUDIO_PROFILE}."
					pactl set-card-profile ${CARD_ID} ${AUDIO_PROFILE}
				fi
				silent_init
				break
			else
				${VERBOSE} && echo "${LOG_HEADER}: ${CARD_SINK} already connected."
				continue
			fi
		else
			${VERBOSE} && echo "${LOG_HEADER}: Waiting for sink (${CARD_ID})."
			sleep .2
			continue
		fi
		sleep .1
	done
}

connect_sink "HDMI/DP" "hdmi|dp" "1"
connect_sink "USB" "usb" "1"
connect_sink "Bluetooth" "bluez" "1"

### Watch for events.
/usr/bin/udevadm monitor -s drm -s sound -s bluetooth 2>/dev/null |  while read LINE
do
	CARD="$(echo ${LINE} | awk '{print $4}')"
	CARD="$(echo ${CARD} | awk 'BEGIN {FS="/"} {print $NF}')"
	if [[ "${CARD}" =~ card[0-9]$ ]] || \
	   [[ "${CARD}" =~ hci[0-9]: ]]
	then
		$VERBOSE && echo "Incoming event on ${CARD}."

		### Connect bluetooth devices (Priority 1)
		for BT_DEVICE in $(bluetoothctl devices Connected 2>/dev/null | awk '{print $2}')
		do
			IS_AUDIO=$(bluetoothctl info ${BT_DEVICE} 2>/dev/null | grep "Audio Sink")
			if [ -n "${IS_AUDIO}" ]
			then
				$VERBOSE && echo "Bluetooth: ${BT_DEVICE} has an audio sink."
				break
			else
				$VERBOSE && echo "Bluetooth: ${BT_DEVICE} has no audio sink."
				continue
			fi
		done

		if [ -n "${IS_AUDIO}" ]
		then
			connect_sink "Bluetooth" "bluez" "10"
			SINK_CHECK=$(pactl get-default-sink)
			if [[ "${SINK_CHECK}" =~ bluez ]]
			then
				break
			fi
		fi

		connect_sink "USB" "usb" "10"
		SINK_CHECK=$(pactl get-default-sink)
		if [[ "${SINK_CHECK}" =~ usb ]]
		then
			break
		fi

		PRIORITY_DEVICES=$(pactl list short cards | awk '/usb|bluez/ {print $2; exit}')
		if [ -z "${PRIORITY_DEVICES}" ]
		then
			connect_sink "HDMI/DP" "hdmi|dp" "10"
			if [[ "${SINK_CHECK}" =~ hdmi ]]
			then
				break
			fi
		else
			${VERBOSE} && echo "HDMI/DP: A higher priority device is available (${PRIORITY_DEVICES})."
		fi
	fi
done
