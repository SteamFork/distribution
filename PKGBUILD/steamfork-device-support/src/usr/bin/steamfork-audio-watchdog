#!/bin/bash

# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2024 SteamFork (https://github.com/SteamFork)

# Source predefined functions and variables
. /etc/profile

source steamfork-devicequirk-set

### Enable logging
case $(steamfork-get-setting system.loglevel) in
    verbose)
	VERBOSE=true
	;;
    debug)
	VERBOSE=true
	DEBUG=true
	;;
    *)
	VERBOSE=false
	DEBUG=false
	;;
esac

if [ "${AUDIO_WATCHDOG}" = "false" ]
then
    $VERBOSE && echo "Watchdog is disabled on this device."
    exit 0
fi

### Wait for audio to initialize and become available.
while true
do
    BOOT_SINK=$(pactl get-default-sink)
    $VERBOSE && echo "Boot Sink: ${BOOT_SINK}"
    if [ ! "${BOOT_SINK}" = "auto_null" ]
    then
	break
    fi
    sleep .1
done

function connect_sink() {
	local LOG_HEADER="${1}"
	local SINK_TYPE="${2}"
	local SINK_RETRY="${3}"
	local AUDIO_PROFILE=$(steamfork-get-setting audio.profile)

	for CONNECT_TIMER in $(seq 1 1 ${SINK_RETRY})
	do
		local CURRENT_SINK=$(pactl get-default-sink)
		local CARD_ID=$(pactl list short cards | awk '/'${SINK_TYPE}'/ {print $1; exit}')
		local CARD_SINK=$(pactl list short sinks | awk '/'${SINK_TYPE}'/ {print $2; exit}')
		if [ -n "${CARD_SINK}" ]
		then
                        if [ ! "${CARD_SINK}" == "${CURRENT_SINK}" ] || \
			   [ ! "${CARD_SINK}" == "${BOOT_SINK}" ]
                        then
				$VERBOSE && echo "${LOG_HEADER}: Set default sink to ${CARD_SINK} (${SINK_TYPE})."
				pactl set-default-source ${CARD_SINK}.monitor
				pactl set-default-sink ${CARD_SINK}
				if [ -n "${AUDIO_PROFILE}" ]
				then
					$VERBOSE && echo "${LOG_HEADER}: Set ${CARD_ID} to ${AUDIO_PROFILE}."
					pactl set-card-profile ${CARD_ID} ${AUDIO_PROFILE}
				fi
				NEW_SINK=$(pactl get-default-sink)
				if [ ! "${CURRENT_SINK}" = "${NEW_SINK}" ]
				then
					$VERBOSE && echo "${LOG_HEADER}: Sink mismatch, retrying."
					continue
				else
					$VERBOSE && echo "${LOG_HEADER}: Sink set to ${NEW_SINK}."
					break
				fi
                        else
                                ${VERBOSE} && echo "${LOG_HEADER}: ${CARD_SINK} already connected."
                                continue
                        fi
		else
			${VERBOSE} && echo "${LOG_HEADER}: Waiting for sink (${CARD_ID})."
			sleep .2
			continue
		fi
		sleep .2
	done
}

connect_sink "Bluetooth" "bluez" "5"
connect_sink "USB" "usb" "5"
connect_sink "HDMI/DP" "hdmi|dp" "5"

### Watch for events.
/usr/bin/udevadm monitor -s drm -s sound -s bluetooth 2>/dev/null |  while read LINE
do
	unset BT_DEVICE IS_AUDIO SINK_CHECK CARD PRIORITY_DEVICES

	CARD="$(echo ${LINE} | awk '{print $4}')"
	CARD="$(echo ${CARD} | awk 'BEGIN {FS="/"} {print $NF}')"
	if [[ "${CARD}" =~ card[0-9]$ ]] || \
	   [[ "${CARD}" =~ hci[0-9]: ]]
	then
		$VERBOSE && echo "Incoming event on ${CARD}."

		### Connect bluetooth devices (Priority 1)
		for BT_DEVICE in $(bluetoothctl devices Connected 2>/dev/null | awk '{print $2}')
		do
			IS_AUDIO=$(bluetoothctl info ${BT_DEVICE} 2>/dev/null | grep "Audio Sink")
			if [ -n "${IS_AUDIO}" ]
			then
				$VERBOSE && echo "Bluetooth: ${BT_DEVICE} has an audio sink."
				break
			else
				$VERBOSE && echo "Bluetooth: ${BT_DEVICE} has no audio sink."
				continue
			fi
		done

		if [ -n "${IS_AUDIO}" ]
		then
			connect_sink "Bluetooth" "bluez" "5"
			SINK_CHECK=$(pactl get-default-sink)
			if [[ "${SINK_CHECK}" =~ bluez ]]
			then
				continue
			fi
		fi

		connect_sink "USB" "usb" "5"
		SINK_CHECK=$(pactl get-default-sink)
		if [[ "${SINK_CHECK}" =~ usb ]]
		then
			continue
		fi

		PRIORITY_DEVICES=$(pactl list short cards | awk '/usb|bluez/ {print $2; exit}')
		if [ -z "${PRIORITY_DEVICES}" ]
		then
			connect_sink "HDMI/DP" "hdmi|dp" "10"
			SINK_CHECK=$(pactl get-default-sink)
			if [[ "${SINK_CHECK}" =~ hdmi ]]
			then
				continue
			fi
		else
			${VERBOSE} && echo "HDMI/DP: A higher priority device is available (${PRIORITY_DEVICES})."
		fi
	fi
	sleep .1
done
